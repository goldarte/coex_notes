#### Автоматическая сборка и кастомизация образа операционной системы raspbian \(CI\)

Иногда возникает необходимость в сборке модифицированного образа системы, например для [своего проекта](https://github.com/artem30801/CleverSwarm) на базе [Клевера](https://github.com/copterexpress/clever). За основу можно взять, например, чистый образ Raspbian Stretch и модифицировать его с нуля, пройдя те же этапы, через который проходит сборка образа Клевера, добавив свои модификации. Однако на данный момент времени \(29.04.19\) сборка образа Клевера занимает [чуть больше часа](https://travis-ci.org/CopterExpress/clever), что превышает ограничения бесплатной сборки в Travis \(50 минут\). Соответственно для проектов на базе Клевера имеет смысл брать за основу уже готовый образ и кастомизировать его. Концепция и основные этапы для автоматизированной сборки изложены ниже.

#### Концепция

Есть [docker](https://www.docker.com/) образ, который содержит инструментарий для выполнения скриптов, копирования файлов и увеличения/сжатия размера образа системы на требуемой платформе для сборки \(например сборка для raspberry pi 3 осуществляется через qemu-arm-static, пример docker image для сборки находится [здесь](https://hub.docker.com/r/goldarte/img-tool)\). При запуске docker образа выполняется скрипт builder/image-build.sh, в котором описан процесс сборки \(например скачивание опорного образа - увеличение свободного места на образе - установка необходимого софта - сжатие образа\), в результате которого создаётся файл образа системы. Триггер сборки, запуск docker образа для сборки, выкладка образа осуществляется с помощью CI \(continuous integration\) системы [Travis](https://travis-ci.com/).

#### Добавление скриптов сборки

1. Добавить в свой проект \(на github\) build скрипты, модифицирующие образ. За основу можно взять скрипты из репозитория Клевера \(папка [builder](https://github.com/CopterExpress/clever/tree/master/builder)\) или из репозитория шоу дронов на основе клеверов \(тоже папка [builder](https://github.com/artem30801/CleverSwarm/tree/master/builder)\). Опорный скрипт, который исполняется безусловно docker образом в этих проектах - builder/image-build.sh.
2. Добавить в свой проект .travis.yml файл, описывающий последовательность этапов выполнения сборки и правила для выкладки образов. [Пример](https://github.com/CopterExpress/clever/blob/master/.travis.yml) из репозитория Клевера, [пример](https://github.com/artem30801/CleverSwarm/blob/master/.travis.yml) из репозитория шоу дронов.

#### Настройка инструмента сборки travis-ci.com

1. Залогиниться в [Travis](/travis-ci.com) через свой Github аккаунт.
2. Для проверки того, что файл .travis.yml добавлен правильно: выбрать свой проект, нажать Trigger build из выпадающего меню справа сверху. Сборка должна начаться и успешно завершиться через некоторое время, если всё правильно.
3. Настроить сборку по тегу и выкладку образа. Если необходимы ключи авторизации \(токены\) для доступа к репозиторию \(например для того, чтобы выложить образ прикреплённым файлом в релиз\), нужно сгенерировать их в своём аккаунте и добавить под названием переменной, которая используется для передачи токена.

#### Запуск сборки в облаке travis-ci.com

1. В папке с клонированным репозиторием создать tag:
2. Запушить его в remote репозиторий на github:

После этого в панели управления travis-ci.com должно отобразиться начало сборки вашего проекта.

#### Запуск сборки на локальной машине

Если есть необходимость собрать образ быстрее, чем в облаке, или поэкспериментировать со сборкой локально, можно запустить docker image на локальной машине. Для этого необходимо в консоли перейти в папку с репозиторием, где прописаны скрипты автоматической сборки, и запустить оттуда docker, например \(подробнее [здесь](https://github.com/goldarte/img-tool/blob/master/README.md)\):

```
cd repo-w-instructions
```

```
docker run --privileged -it --rm -v /dev:/dev -v $(pwd):/mnt goldarte/img-tool:v0.5
```



